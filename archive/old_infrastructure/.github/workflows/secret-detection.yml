name: Secret Detection

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  detect-secrets:
    runs-on: ubuntu-latest
    name: Secret Detection Scan
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
      with:
        # For PRs, we only need the changes; for push events, fetch more history
        fetch-depth: ${{ github.event_name == 'pull_request' && 1 || 0 }}
    
    - name: Cache GitLeaks binary
      id: cache-gitleaks
      uses: actions/cache@v4
      with:
        path: /usr/local/bin/gitleaks
        key: gitleaks-${{ runner.os }}-v8.21.2
        restore-keys: |
          gitleaks-${{ runner.os }}-
    
    - name: Install GitLeaks
      if: steps.cache-gitleaks.outputs.cache-hit != 'true'
      run: |
        # Install latest version of GitLeaks
        GITLEAKS_VERSION=$(curl -s https://api.github.com/repos/gitleaks/gitleaks/releases/latest | grep '"tag_name"' | cut -d'"' -f4)
        curl -sSfL "https://github.com/gitleaks/gitleaks/releases/download/${GITLEAKS_VERSION}/gitleaks_${GITLEAKS_VERSION#v}_linux_x64.tar.gz" | tar -xz
        sudo mv gitleaks /usr/local/bin/
    
    - name: Verify GitLeaks installation
      run: |
        gitleaks version
    
    - name: Run GitLeaks scan on current changes
      id: gitleaks-scan
      run: |
        echo "Running GitLeaks scan..."
        
        # For pull requests, scan only the changes
        if [ "${{ github.event_name }}" = "pull_request" ]; then
          echo "Scanning PR changes from ${{ github.event.pull_request.base.sha }} to ${{ github.sha }}"
          gitleaks detect --config=.gitleaks.toml --verbose --no-git --source=. --log-opts="${{ github.event.pull_request.base.sha }}..${{ github.sha }}" --report-format=json --report-path=gitleaks-report.json || GITLEAKS_EXIT_CODE=$?
        else
          echo "Scanning entire repository"
          gitleaks detect --config=.gitleaks.toml --verbose --source=. --report-format=json --report-path=gitleaks-report.json || GITLEAKS_EXIT_CODE=$?
        fi
        
        # Store exit code for later use
        echo "GITLEAKS_EXIT_CODE=${GITLEAKS_EXIT_CODE:-0}" >> $GITHUB_ENV
        
        # Always generate human-readable report
        if [ -f gitleaks-report.json ]; then
          echo "=== GitLeaks Scan Results ==="
          if [ -s gitleaks-report.json ] && [ "$(cat gitleaks-report.json)" != "null" ]; then
            echo "‚ö†Ô∏è Potential secrets detected!"
            cat gitleaks-report.json | jq -r '
              if type == "array" then
                .[] | "File: \(.File)\nLine: \(.StartLine)\nRule: \(.RuleID) - \(.Description)\nSecret: \(.Secret[0:50])...\n---"
              else
                "No secrets found or invalid format"
              end
            ' 2>/dev/null || echo "Error parsing JSON report"
          else
            echo "‚úÖ No secrets detected"
          fi
          echo "========================="
        else
          echo "No report file generated"
        fi
    
    - name: Upload GitLeaks report
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: gitleaks-report
        path: gitleaks-report.json
        retention-days: 30
    
    - name: Evaluate scan results
      run: |
        if [ "$GITLEAKS_EXIT_CODE" = "1" ]; then
          echo "‚ùå GitLeaks found potential secrets in the code!"
          echo ""
          echo "## üîí Secret Detection Results"
          echo ""
          echo "GitLeaks has detected potential secrets or credentials in your code."
          echo ""
          echo "### What to do next:"
          echo "1. Review the findings above"
          echo "2. Remove any real secrets from your code"
          echo "3. Use environment variables or secure secret management instead"
          echo "4. If these are false positives, update the allowlist in .gitleaks.toml"
          echo ""
          echo "### For legitimate secrets:"
          echo "- Use GitHub Secrets for CI/CD variables"
          echo "- Use environment variables for runtime configuration"  
          echo "- Use .env files (never commit these!)"
          echo "- Consider using Azure Key Vault or similar secret management"
          echo ""
          echo "### Documentation:"
          echo "- [GitHub Secrets](https://docs.github.com/en/actions/security-guides/encrypted-secrets)"
          echo "- [Environment Variables](https://12factor.net/config)"
          echo ""
          exit 1
        elif [ "$GITLEAKS_EXIT_CODE" = "2" ]; then
          echo "‚ö†Ô∏è GitLeaks encountered an error during scanning"
          exit 1
        else
          echo "‚úÖ No secrets detected - build can proceed"
        fi
    
    # PR commenting step removed due to permissions limitations
    # The workflow logs provide sufficient information for debugging